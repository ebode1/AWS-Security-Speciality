Install CloudWatch Logs Agent on EC2 Instance and View CloudWatch Metrics
(https://www.whizlabs.com/labs/install-cloudwatch-logs-agent-on-ec2-instance-and-view-cloudwatch-metrics)
=====================================================================================

Lab Details
***********
This lab walks you through installing the CloudWatch Logs Agent on an EC2 instance and using it to view metrics. This can be very helpful when testing your application.
Duration: 30 minutes
=====================================================================================


Task Details
************

Sign into the AWS Management Console.

Create an EC2 instance.

SSH into EC2 Instance.

Download and Install the Cloudwatch agent on EC2.

Configure and Start the Agent.

View the metric in the Cloudwatch Metrics.
=====================================================================================


Lab Steps
*********

Task 1: Sign in to AWS Management Console
Click on the  button, and you will get redirected to AWS Console in a new browser tab.

On the AWS sign-in page,

Leave the Account ID as default. Never edit/remove the 12 digit Account ID present in the AWS Console. otherwise, you cannot proceed with the lab.

Now copy your User Name and Password in the Lab Console to the IAM Username and Password in AWS Console and click on the Sign in button.

Once Signed In to the AWS Management Console, Make the default AWS Region as US East (N. Virginia) us-east-1.

Select Maybe later in New AWS Console Home page pop-up 

            

Task 2: Launching an EC2 Instance
Make sure you are in the N.Virginia Region.

Navigate to EC2 by clicking on the  menu at the top, then click on EC2 in the Compute section.

Navigate to Instances on the left panel and click on  

 Choose an Amazon Machine Image (AMI): Select Amazon Linux 2 AMI in the drop-down.

Choose architecture as 64-bit(x86)
          

    6. Choose an Instance Type: Select t2.micro.

         

     7. For Key pair: Select Create a new key pair Button

Key pair name: WhizKey

Key pair type: RSA

Private key file format: .pem

Select Create key pair Button.

           

   9. In Network Settings Click on Edit Button:

Auto-assign public IP: Enable

Select Create new Security group

Security group name : Enter MyEC2Server_SG

Description : Enter Security Group to allow traffic to EC2



Check Allow SSH from and Select Anywhere from dropdown

To add SSH,

Choose Type: 

Source: Select  

   10.   Scroll Down to Advanced Settings, Select IAM instance profile already created for you as task124_role_<RANDOM_NUMBER>

    11. Leave the rest of the things as default. 

    12. Click on the  

Task 4: SSH into the EC2 Instance
Please follow the steps in SSH into EC2 Instance.

Task 5: Download and Install the Cloudwatch Agent
Download the Cloudwatch Unified Agent

wget https://s3.amazonaws.com/amazoncloudwatch-agent/amazon_linux/amd64/latest/amazon-cloudwatch-agent.rpm


Install the Cloudwatch Agent

sudo rpm -U ./amazon-cloudwatch-agent.rpm


Task 6: Configure and Start the Cloudwatch Agent
Open the setup wizard

sudo /opt/aws/amazon-cloudwatch-agent/bin/amazon-cloudwatch-agent-config-wizard


Enter these values asked during setup:

On which OS are you planning to use the agent? : Enter 1

Are you using EC2 or On-Premises? : Enter 1

Which user are you planning to run the agent? : Enter 1

Do you want to turn on the StatsD daemon? : Enter 2

Do you want to monitor metrics from CollectD? : Enter 2

Do you want to monitor any host metrics? Enter 1

Do you want to monitor CPU metrics per core? Enter 1

Do you want to add ec2 dimensions into all of your metrics if the info is available? : Enter 1

Would you like to collect your metrics at high resolution? : Enter 1 (1s)

Which default metrics config do you want?: Enter 2

Are you satisfied with the above config? Enter 1

Do you have any existing CloudWatch log Agent configuration file to import for migration? : Enter 2

Do you want to monitor any log files? : Enter 2

Do you want to store the config in the SSM parameter store? : Enter 2

Note: if you make any mistakes in the above configuration, you can run the configuration setup again whenever you want. The configurations that you make is saved in a JSON File.

Start the Agent:

sudo /opt/aws/amazon-cloudwatch-agent/bin/amazon-cloudwatch-agent-ctl -a fetch-config -m ec2 -c file:/opt/aws/amazon-cloudwatch-agent/bin/config.json -s


Check Agent Status

systemctl status amazon-cloudwatch-agent


Task 7: View the CloudWatch Metrics
Navigate to CloudWatch by clicking on the  menu available under the Management and Governance section.

Make sure you are in the N.Virginia Region.

Click on Metrics in the Left Panel.

You should be able to see CWAgent under All Metrics (Custom Namespaces). 

Note: If you are not able to see CWAgent, please wait for at least 2 minutes and then refresh the browser page.



Click on the CloudWatch Agent and you will be able to see visuals for that metric



Click on any Metric and you will be able to see the metrics on the above graph refreshed every 1 sec



Completion and Conclusion
You have created an EC2 Instance.

You have successfully accessed the EC2 instance via SSH.

You have downloaded and installed the CloudWatch Agent.

You have configured and started the agent.

You have viewed a cloud metric in CloudWatch.

